<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario con Calendario (Flatpickr)</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body {
      background-image: url('/img/osva3.jpg'); /* Agregar imagen de fondo */
      background-size: cover; /* Ajustar tamaño de la imagen */
      background-position: center; /* Posición de la imagen */
    }
    .formulario {
      background-color: rgba(255, 255, 255, 0.8); /* Color de fondo del formulario con transparencia */
      border-radius: 10px; /* Bordes redondeados */
      padding: 20px;
      margin-top: 50px; /* Margen superior */
    }
    label {
      font-weight: bold; /* Texto de los labels en negrita */
    }
    .btn-cafe {
      background-color: #0bc1c7; /* Color café para el botón */
      border-color: #000000; /* Borde café para el botón */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="formulario">
          <h2 class="text-center mb-4">Bolillito</h2>
          <h5 class="text-center mb-4" style="font-size: 15px;">¡Hola! Introduce tus datos, los estaremos enviando a tu correo.</h5>
          <form id="contactForm" class="needs-validation" novalidate action="/register" method="POST">
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombre" name="nombre" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce tu nombre.</div>
            </div>
            <div class="mb-3">
              <label for="edad" class="form-label">Edad</label>
              <input type="number" class="form-control" id="edad" name="edad" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce tu edad.</div>
            </div>
            <div class="mb-3">
              <label for="escolaridad" class="form-label">Escolaridad</label>
              <input type="text" class="form-control" id="escolaridad" name="escolaridad" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce tu escolaridad.</div>
            </div>
            <div class="mb-3">
              <label for="grupo" class="form-label">Grupo</label>
              <input type="text" class="form-control" id="grupo" name="grupo" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce tu grupo.</div>
            </div>
            <div class="mb-3">
              <label for="vive_con" class="form-label">Vive con</label>
              <input type="text" class="form-control" id="vive_con" name="vive_con" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce con quién vives.</div>
            </div>
            <div class="mb-3">
              <label for="fuente_referencia" class="form-label">Fuente de referencia</label>
              <input type="text" class="form-control" id="fuente_referencia" name="fuente_referencia" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce tu fuente de referencia.</div>
            </div>
            <div class="mb-3">
              <label for="entrevistador" class="form-label">Entrevistador o entrevistadores</label>
              <input type="text" class="form-control" id="entrevistador" name="entrevistador" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce el nombre del entrevistador.</div>
            </div>
            <div class="mb-3">
              <label for="correo" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="correo" name="correo" required>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, introduce un correo válido.</div>
            </div>
            <div class="mb-3">
              <label for="dia_cita" class="form-label">Día de la cita</label>
              <input type="text" class="form-control" id="dia_cita" name="dia_cita" required readonly>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, selecciona el día de la cita.</div>
            </div>
            <div class="mb-3">
              <label for="hora_cita" class="form-label">Hora de la cita</label>
              <select class="form-select" id="hora_cita" name="hora_cita" required>
                <option value="">Selecciona la hora</option>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
              </select>
              <div class="valid-feedback">¡Perfecto!</div>
              <div class="invalid-feedback">Por favor, selecciona la hora de la cita.</div>
            </div>
            <input type="hidden" id="active" name="active" value="true">
            <div class="text-center">
              <button type="submit" class="btn btn-cafe">Iniciar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS (opcional, solo si necesitas funcionalidades de Bootstrap) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Inicialización de Flatpickr para el campo de fecha
    flatpickr("#dia_cita", {
      // Configuración de opciones
      enable: [
        function(date) {
          // Solo permitir días de lunes a viernes (de 1 a 5)
          return date.getDay() >= 1 && date.getDay() <= 5; // 1 a 5 son lunes a viernes
        }
      ],
      dateFormat: "Y-m-d", // Formato de fecha
      minDate: "today", // La fecha mínima permitida es hoy
      locale: {
        firstDayOfWeek: 1 // Lunes como primer día de la semana
      },
      onChange: function(selectedDates, dateStr, instance) {
        // Obtener la fecha seleccionada
        var selectedDate = selectedDates[0];

        // Formatear la fecha seleccionada para comparar con las citas ocupadas
        var formattedDate = instance.formatDate(selectedDate, "Y-m-d");

        // Hacer una solicitud al servidor para obtener las citas ocupadas para esa fecha
        fetch('/citas_ocupadas')
          .then(response => response.json())
          .then(data => {
            // Obtener el array de citas ocupadas
            var citasOcupadas = data;

            // Filtrar las horas ocupadas para la fecha seleccionada
            var horasOcupadas = citasOcupadas
              .filter(cita => cita.dia_cita === formattedDate)
              .map(cita => cita.hora_cita);

            // Actualizar las opciones del select de hora_cita
            var selectHora = document.getElementById('hora_cita');
            selectHora.innerHTML = '<option value="">Selecciona la hora</option>';
            var options = [
              { value: '09:00', text: '9:00 AM' },
              { value: '10:00', text: '10:00 AM' },
              { value: '11:00', text: '11:00 AM' },
              { value: '12:00', text: '12:00 PM' },
              { value: '13:00', text: '1:00 PM' },
              { value: '14:00', text: '2:00 PM' },
              { value: '15:00', text: '3:00 PM' }
            ];

            options.forEach(option => {
              var optionElement = document.createElement('option');
              optionElement.value = option.value;
              optionElement.textContent = option.text;
              if (horasOcupadas.includes(option.value)) {
                optionElement.disabled = true;
              }
              selectHora.appendChild(optionElement);
            });

            // Reinicializar Flatpickr para actualizar las fechas bloqueadas dinámicamente
            instance.redraw();
          })
          .catch(error => console.error('Error al obtener citas ocupadas:', error));
      }
    });

    // Validación de formulario con Bootstrap
    (function () {
      'use strict'

      // Busca todos los formularios a los que se les debe añadir la validación de Bootstrap
      var forms = document.querySelectorAll('.needs-validation')

      // Itera sobre ellos y previene el envío si no son válidos
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
              event.preventDefault()
              event.stopPropagation()
            } else {
              // Aquí puedes mostrar la alerta
              var diaCita = document.getElementById('dia_cita').value;
              var horaCita = document.getElementById('hora_cita').value;
              alert("Tus datos han sido guardados correctamente. Tu cita está programada para el " + diaCita + " a las " + horaCita + ".");
            }

            form.classList.add('was-validated')
          }, false)
        })
    })();
  </script>
</body>
</html>
